---
title: "Phaco meta analysis"
author: "Patrick Mineault"
date: "14/02/2017"
output: pdf_document
---

# Load data
We load data from a CSV exported from Stata. The `Mo` variables refer to what happens after 6 months. The letter variables `Z`, `AA` etc. refer to what happens after 12 months. That's a bug in how Stata exports names of variables which start with a number - the columns were named `6mo...` and `12mo...`.

```{r echo=FALSE} 
library(tidyverse)
library(meta)
library(ggrepel)

source("read-data.R")

setwd("~/Documents/phaco")
df <- read.data()
```


# Full analysis

## 6 month follow-up

```{r fig.width=10, fig.height=8}
df_ <- df %>% filter(!is.na(df$SixMoAbsIOPChangeMean), df$subtype != "acute") %>% mutate(subtype=factor(subtype))
m <- metagen(SixMoAbsIOPChangeMean, 
             SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=SixMoEyes)
forest(m, 
       comb.fixed=FALSE, 
       digits=1, 
       digits.se = 2, 
       overall=FALSE, 
       leftcols=c("studlab", "TE", "seTE", "n.e"))
```

## 12-month follow up

```{r fig.width=10, fig.height=9}
df_ <- df %>% filter(!is.na(df$OneYAbsIOPChangeMean), df$subtype != "acute", MIGsYorN == 'N') %>% mutate(subtype=factor(subtype))
m <- metagen(OneYAbsIOPChangeMean, 
             OneYAbsIOPChangeStdDev / sqrt(OneYEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=OneYEyes)
forest(m, 
       comb.fixed=FALSE, 
       digits=1, 
       digits.se = 2, 
       overall=FALSE, 
       leftcols=c("studlab", "TE", "seTE", "n.e"))
```

## Last period

```{r fig.width=10, fig.height=9}
df_ <- df %>% 
  filter(!is.na(df$LastPeriodAbsIOPChangeMean), df$subtype != "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=factor(subtype))
m <- metagen(LastPeriodAbsIOPChangeMean, 
             LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=LastPeriodEyes)
forest(m, 
       comb.fixed=FALSE, 
       digits=1, 
       digits.se = 2, 
       overall=FALSE, 
       leftcols=c("studlab", "TE", "seTE", "n.e"))
```

## MIGS

```{r fig.width=10, fig.height=5.5}
df_ <- df %>% 
  filter(!is.na(df$LastPeriodAbsIOPChangeMean), df$subtype != "acute", MIGsYorN == 'Y') %>% 
  mutate(subtype=factor(subtype)) %>% dplyr::arrange(TypesofMIGSifany, Year)
m <- metagen(LastPeriodAbsIOPChangeMean, 
             LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes), 
             study.name, 
             data=df_,
             n.e=LastPeriodEyes)
forest(m, 
       comb.fixed=FALSE, 
       digits=1, 
       digits.se = 2, 
       overall=TRUE, 
       leftcols=c("studlab", "TE", "seTE", "n.e", "TypesofMIGSifany"),
       leftlabs=c("Study", "TE", "seTE", "Total", "Type"))
```

## Acute

```{r fig.width=10, fig.height=5.5}
cat("=========================================================================\n")
cat("Six months: \n")
cat("=========================================================================\n")
df_ <- df %>% 
  filter(!is.na(df$SixMoAbsIOPChangeMean), df$subtype == "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=factor(subtype)) %>% dplyr::arrange(Year)
m <- metagen(SixMoAbsIOPChangeMean, 
             SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes), 
             study.name, 
             data=df_,
             n.e=SixMoEyes, comb.fixed = FALSE)
print(m)

cat("=========================================================================\n")
cat("One year: \n")
cat("=========================================================================\n")
df_ <- df %>% 
  filter(!is.na(df$OneYAbsIOPChangeMean), df$subtype == "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=factor(subtype)) %>% dplyr::arrange(Year)
m <- metagen(OneYAbsIOPChangeMean, 
             OneYAbsIOPChangeStdDev / sqrt(OneYEyes),
             study.name, 
             data=df_,
             n.e=OneYEyes, comb.fixed = FALSE)
print(m)

cat("=========================================================================\n")
cat("Last period: \n")
cat("=========================================================================\n")
df_ <- df %>% 
  filter(!is.na(df$LastPeriodAbsIOPChangeMean), df$subtype == "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=factor(subtype)) %>% dplyr::arrange(Year)
m <- metagen(LastPeriodAbsIOPChangeMean, 
             LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes),
             study.name, 
             data=df_,
             n.e=LastPeriodEyes, comb.fixed = FALSE)
print(m)
```

## Meds

TODO(Patrick):
Figure out a less hacky way of doing this.
Wait for answers on [this question](http://stats.stackexchange.com/questions/263109/meta-analysis-of-low-count-data)

```{r fig.width=10, fig.height=10}
df_ <- df %>% 
  filter(!is.na(df$RxPostOpMean), !is.na(df$RxPreOpMean), df$subtype != "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=factor(subtype), LastPeriodEyes = ifelse(is.na(LastPeriodEyes), OneYEyes, LastPeriodEyes))
m <- metagen(RxPostOpMean - RxPreOpMean, 
             sqrt(2) / sqrt(LastPeriodEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=LastPeriodEyes)
forest(m, 
       comb.fixed=FALSE, 
       digits=1, 
       digits.se = 2, 
       overall=FALSE, 
       leftcols=c("studlab", "TE", "seTE", "n.e"))
```

# Retrospective only

TODO(Patrick): Do this analysis.

# Sensitivity analysis

TODO(Patrick): Do this analysis.

# Correlation between meds and drop in IOP

How is IOP drop related to change in meds? Two hypotheses:

  * Those studies that see the largest IOP drops also have drop in meds, as doctors see that can use the newfound *slack* to decrease the number of meds people take
  * The studies that see the largest IOP drops are those that don't change meds, because dropping meds would also increase IOP

So which is it?

```{r}
df_ <- df %>% mutate(RxChangeMean = RxPostOpMean - RxPreOpMean,
                     RxChangeSEM  = sqrt(1 / ifelse(is.na(LastPeriodEyes), OneYEyes, LastPeriodEyes)),
                     LastPeriodAbsIOPChangeSEM = LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes))

ggplot(df_, aes(x  =LastPeriodAbsIOPChangeMean, 
               xmin=LastPeriodAbsIOPChangeMean - 1.96*LastPeriodAbsIOPChangeSEM,
               xmax=LastPeriodAbsIOPChangeMean + 1.96*LastPeriodAbsIOPChangeSEM,
               y   =RxChangeMean,
               ymin=RxChangeMean - 1.96*RxChangeSEM,
               ymax=RxChangeMean + 1.96*RxChangeSEM,
               color=subtype
               )) + geom_errorbar() + geom_errorbarh()
```

```{r}
ggplot(df_ %>% filter(subtype=='OAG' & MIGsYorN == 'N'), 
        aes(x  =LastPeriodAbsIOPChangeMean, 
            xmin=LastPeriodAbsIOPChangeMean - 1.96*LastPeriodAbsIOPChangeSEM,
            xmax=LastPeriodAbsIOPChangeMean + 1.96*LastPeriodAbsIOPChangeSEM,
            y   =RxChangeMean,
            ymin=RxChangeMean - 1.96*RxChangeSEM,
            ymax=RxChangeMean + 1.96*RxChangeSEM,
            label=study.name
           )) + geom_errorbar(alpha=.2) + geom_errorbarh(alpha=.2) + ggtitle('OAG only') + geom_text_repel(segment.alpha = 0)
```

In fact, apart from the Pfeiffer et al. (2015) study, there is an apparent positive correlation between the two effect sizes: studies with larger drops in IOP also tend to see larger drops in Rx.

```{r warning=FALSE}
draw.corr <- function(x.mean, x.sem, y.mean, y.sem) {
  d_ <- data.frame(x = rnorm(n = length(x.mean), mean=x.mean, sd = x.sem),
                  y = rnorm(n = length(x.mean), mean=y.mean, sd = y.sem))
  with(d_ %>% filter(!is.na(x) & !is.na(y)), cor(x, y))
}

cat("Mean +- SE correlation, without Pfeiffer et al\n")
df_ <- df %>% filter(!(study.name %in% c("Pfeiffer et. al (2015)")), subtype=='OAG', MIGsYorN == 'N')
drawn.corrs <- with(df_, replicate(n = 100, 
                                   draw.corr(LastPeriodAbsIOPChangeMean, 
                                             LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes), 
                                             RxPostOpMean - RxPreOpMean, 
                                             1 / sqrt(LastPeriodEyes))))
mean(drawn.corrs)
sd(drawn.corrs)

cat("Mean +- SE correlation, with Pfeiffer et al\n")
df_ <- df %>% filter(subtype=='OAG', MIGsYorN == 'N')
drawn.corrs <- with(df_, replicate(n = 100, 
                                  draw.corr(LastPeriodAbsIOPChangeMean, 
                                             LastPeriodAbsIOPChangeStdDev / sqrt(LastPeriodEyes), 
                                             RxPostOpMean - RxPreOpMean, 
                                             1 / sqrt(LastPeriodEyes))))
mean(drawn.corrs)
sd(drawn.corrs)

```

## Joint inferences

Measure the correlation between different outcomes (IOP at 6 months vs. 12 months).

```{r}
ggplot(df, aes(x   =SixMoAbsIOPChangeMean, 
               xmin=SixMoAbsIOPChangeMean - 1.96*SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes),
               xmax=SixMoAbsIOPChangeMean + 1.96*SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes),
               y   = OneYAbsIOPChangeMean,
               ymin= OneYAbsIOPChangeMean - 1.96*OneYAbsIOPChangeStdDev / sqrt(OneYEyes),
               ymax= OneYAbsIOPChangeMean + 1.96*OneYAbsIOPChangeStdDev / sqrt(OneYEyes),
               label=study.name,
               color=subtype
               )) + geom_errorbar() + geom_errorbarh()
```

It's very clear that six months and 12 months IOP are highly correlated. 

```{r warning=FALSE}
df_ <- df %>% filter(subtype=='OAG')
drawn.corrs <- with(df_, replicate(n = 100, 
                                   draw.corr(SixMoAbsIOPChangeMean, 
                                             SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes), 
                                             OneYAbsIOPChangeMean, 
                                             OneYAbsIOPChangeStdDev / sqrt(OneYEyes))))
cat("Mean +- SE correlation, OAG only\n")
print(mean(drawn.corrs))
print(sd(drawn.corrs))

df_ <- df
drawn.corrs <- with(df_, replicate(n = 100, 
                                   draw.corr(SixMoAbsIOPChangeMean, 
                                             SixMoAbsIOPChangeStdDev / sqrt(SixMoEyes), 
                                             OneYAbsIOPChangeMean, 
                                             OneYAbsIOPChangeStdDev / sqrt(OneYEyes))))
cat("Mean +- SE correlation, All subtypes\n")
print(mean(drawn.corrs))
print(sd(drawn.corrs))
```

That's really high. Let's use mvmeta to infer the effect size for all periods together.

```{r}
library(mvmeta)

fill.na <- function(x, y, z) {
  return(ifelse(!is.na(x), 
                   x,
                   ifelse(is.na(y), 
                          z,
                          ifelse(is.na(z),
                            y,
                            sqrt((y**2 + z**2) / 2 )))))
}

get.correlation.matrices.tri <- function(x, y, z, assumed.rho) {
  S <- list()
  for(i in 1:length(x)) {
    xx <- fill.na(x[i], y[i], z[i])
    yy <- fill.na(y[i], x[i], z[i])
    zz <- fill.na(z[i], x[i], y[i])
    S[[i]] <- matrix(c(xx ** 2, xx * yy * assumed.rho, xx * zz * assumed.rho ** 2,
                       xx * yy * assumed.rho, yy ** 2, zz * yy* assumed.rho,
                       xx * zz * assumed.rho ** 2, zz * yy * assumed.rho, zz * zz), ncol=3)
  }
  S
}

df_ <- df %>% filter(!is.na(LastPeriodAbsIOPChangeStdDev) | 
                     !is.na(SixMoAbsIOPChangeStdDev) | 
                     !is.na(OneYAbsIOPChangeStdDev), subtype %in% c('OAG', 'ACG'), MIGsYorN == 'N')

thefit <- mvmeta(cbind(SixMoAbsIOPChangeMean, OneYAbsIOPChangeMean, LastPeriodAbsIOPChangeMean) ~ subtype, 
       S=get.correlation.matrices.tri(df_$SixMoAbsIOPChangeStdDev / sqrt(df_$SixMoEyes), 
                                      df_$OneYAbsIOPChangeStdDev / sqrt(df_$OneYEyes), 
                                      df_$LastPeriodAbsIOPChangeStdDev / sqrt(df_$LastPeriodEyes), .7),
       data=df_,
       method="reml")

summary(thefit)
newdata <- data.frame(subtype=c('OAG', 'ACG'))
pred <- predict(thefit, newdata, se=TRUE)
newdata$SixMoAbsIOPChangeMean <- pred$fit[,1]
newdata$OneYAbsIOPChangeMean <- pred$fit[,2]
newdata$LastPeriodAbsIOPChangeMean <- pred$fit[,3]
newdata$SixMoAbsIOPChangeSEM <- pred$se[,1]
newdata$OneYAbsIOPChangeSEM <- pred$se[,2]
newdata$LastPeriodAbsIOPChangeSEM <- pred$se[,3]

library(reshape2)
nd <- melt(newdata)
nd$period <- substr(nd$variable, 0, 4)
nd$metric <- substr(nd$variable, nchar(as.character(nd$variable)) - 3, nchar(as.character(nd$variable)))
nd
df_ <- dcast(nd, formula = subtype + period ~ metric)
df_$period <- factor(df_$period, c('SixM', 'OneY', 'Last'))
ggplot(df_, aes(x=period, 
                y=Mean, 
                ymin=Mean - 1.96*eSEM, 
                ymax=Mean + 1.96*eSEM, 
                group=subtype,
                fill=subtype)) + geom_ribbon(alpha=.2) + geom_line(aes(color=subtype)) + ylab("Inferred IOP change per period")
```

# Meta-regression

```{r}
df_ <- df %>% filter(!is.na(df$OneYAbsIOPChangeMean), df$subtype != "acute", MIGsYorN == 'N') %>% 
  mutate(subtype=relevel(factor(subtype), ref="OAG"))
m <- metagen(OneYAbsIOPChangeMean, 
             OneYAbsIOPChangeStdDev / sqrt(OneYEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=OneYEyes)

print(metareg(~ OneYEyes, x=m))
print(metareg(~ OneYEyes * subtype, x=m))
print(metareg(~ Year, x=m))
print(metareg(~ Year * subtype, x=m))
print(metareg(~ PreOpIOPMean, x=m))
print(metareg(~ PreOpIOPMean * subtype, x=m))

# Same, restricted to OAG only
df_ <- df %>% filter(!is.na(df$OneYAbsIOPChangeMean), df$subtype == "OAG", MIGsYorN == 'N') %>% 
  mutate(subtype=relevel(factor(subtype), ref="OAG"))
m <- metagen(OneYAbsIOPChangeMean, 
             OneYAbsIOPChangeStdDev / sqrt(OneYEyes), 
             study.name, 
             data=df_,
             byvar=subtype,
             n.e=OneYEyes)

bubble(metareg(~ PreOpIOPMean, x=m))
```